# CNB äº‘åŸç”Ÿæ„å»ºé…ç½®æ–‡ä»¶
# æ–‡æ¡£: https://cnb.cool/docs/cloud-native-build

# main åˆ†æ”¯æ¨é€è§¦å‘ - å‰ç«¯æ„å»º
main:
  push:
    - name: å‰ç«¯æ„å»º
      docker:
        image: node:22
        volumes:
          - node_modules:copy-on-write
      stages:
        - name: å®‰è£…ä¾èµ–
          script: npm ci
        - name: æ„å»ºå‰ç«¯
          script: |
            echo "ğŸ“¦ å¼€å§‹æ„å»ºå‰ç«¯..."
            npm run build
            echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
            ls -lh dist/

# tags æ¨é€è§¦å‘ - å®Œæ•´å‘å¸ƒæµç¨‹
tags:
  push:
    - name: æ„å»º DEB å®‰è£…åŒ…
      docker:
        image: node:22
        volumes:
          - node_modules:copy-on-write
      stages:
        - name: å®‰è£…ä¾èµ–
          script: npm ci
        - name: æ„å»ºå‰ç«¯
          script: npm run build
        - name: å®‰è£…æ„å»ºå·¥å…·
          script: |
            echo "ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–..."
            apt-get update
            apt-get install -y fakeroot binutils
        - name: æ„å»º Electron åº”ç”¨
          script: |
            echo "ğŸ”¨ æ„å»º Electron åº”ç”¨..."
            npm run electron:build:deb
        - name: æ˜¾ç¤ºæ„å»ºç»“æœ
          script: |
            echo "âœ… æ„å»ºå®Œæˆï¼"
            echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
            ls -lh release/
            if [ -f release/*.deb ]; then
              echo ""
              echo "ğŸ“¦ DEB åŒ…ä¿¡æ¯:"
              dpkg -I release/*.deb | grep -E "Package|Version|Architecture|Installed-Size"
            fi
      failStages:
        - name: æ„å»ºå¤±è´¥é€šçŸ¥
          script: |
            echo "âŒ æ„å»ºå¤±è´¥ï¼"
            echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å¹¶ä¿®å¤é”™è¯¯"

# PR/MR è§¦å‘ - ä»£ç æ£€æŸ¥
main:
  pull_request:
    - name: ä»£ç è´¨é‡æ£€æŸ¥
      docker:
        image: node:22
        volumes:
          - node_modules:copy-on-write
      stages:
        - name: å®‰è£…ä¾èµ–
          script: npm ci
        - name: æ„å»ºæ£€æŸ¥
          script: |
            echo "ğŸ” æ£€æŸ¥ä»£ç æ„å»º..."
            npm run build
            echo "âœ… ä»£ç æ„å»ºæ£€æŸ¥é€šè¿‡"
      failStages:
        - name: æ£€æŸ¥å¤±è´¥é€šçŸ¥
          script: |
            echo "âŒ ä»£ç æ£€æŸ¥å¤±è´¥ï¼"
            echo "è¯·ä¿®å¤ä»£ç åå†æäº¤ PR"

# æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
$:
  manual:
    - name: å¿«é€Ÿæµ‹è¯•
      docker:
        image: node:22
        volumes:
          - node_modules:copy-on-write
      stages:
        - name: æµ‹è¯•æ„å»º
          script: |
            echo "ğŸ”§ æ‰‹åŠ¨è§¦å‘æµ‹è¯•æ„å»º"
            npm ci
            npm run build
            echo "âœ… æµ‹è¯•æ„å»ºå®Œæˆ"
