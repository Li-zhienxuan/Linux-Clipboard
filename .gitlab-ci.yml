# CNB CI/CD é…ç½®æ–‡ä»¶
# CNB (cnb.cool) åŸºäºŽ GitLabï¼Œä½¿ç”¨ .gitlab-ci.yml æ ¼å¼

stages:
  - build
  - package
  - release

variables:
  # Node.js ç‰ˆæœ¬
  NODE_VERSION: "22"
  # é¡¹ç›®åç§°
  PROJECT_NAME: "linux-clipboard"

# ç¼“å­˜ node_modules
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

# æž„å»ºé˜¶æ®µ - ç¼–è¯‘å‰ç«¯ä»£ç 
build:frontend:
  stage: build
  image: node:22
  script:
    - echo "ðŸ“¦ å¼€å§‹æž„å»ºå‰ç«¯..."
    - npm ci
    - npm run build
    - echo "âœ… å‰ç«¯æž„å»ºå®Œæˆ"
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  only:
    - main
    - tags
    - merge_requests

# æ‰“åŒ…é˜¶æ®µ - æž„å»º .deb å®‰è£…åŒ…
package:deb:
  stage: package
  image: node:22
  dependencies:
    - build:frontend
  before_script:
    # å®‰è£… Electron æž„å»ºä¾èµ–
    - apt-get update
    - apt-get install -y fakeroot binutils
  script:
    - echo "ðŸ“¦ å¼€å§‹æ‰“åŒ… .deb å®‰è£…åŒ…..."
    - npm ci
    - npm run build
    - npm run electron:build:deb
    - echo "âœ… æ‰“åŒ…å®Œæˆ"
    - ls -lh release/
  artifacts:
    paths:
      - release/*.deb
    expire_in: 1 day
  only:
    - main
    - /^v.*$/

# å‘å¸ƒé˜¶æ®µ - åˆ›å»º Release (ä»…è§¦å‘ tag æ—¶)
release:create:
  stage: release
  image: node:22
  dependencies:
    - package:deb
  script:
    - echo "ðŸš€ åˆ›å»º Release..."
    - VERSION=${CI_COMMIT_TAG#v}
    - echo "ç‰ˆæœ¬: $VERSION"
    - echo "Commit: $CI_COMMIT_SHA"
    - echo "å‘å¸ƒæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S (CST, UTC+8)')"

    # åˆ›å»º Release ä¿¡æ¯æ–‡ä»¶
    - cat > RELEASE_INFO_${VERSION}.txt <<EOF
      ========================================
      Linux-Clipboard ${VERSION} å‘å¸ƒä¿¡æ¯
      ========================================

      å‘å¸ƒæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S (CST, UTC+8)')
      ç‰ˆæœ¬: ${VERSION}
      CI/CD: CNB GitLab CI è‡ªåŠ¨å‘å¸ƒ

      å®‰è£…åŒ…:
        æ–‡ä»¶å: linux-clipboard_${VERSION}_amd64.deb
        ä¸‹è½½: https://cnb.cool/ZhienXuan/Linux-Clipboard/-/releases/${VERSION}/downloads/linux-clipboard_${VERSION}_amd64.deb

      å®‰è£…å‘½ä»¤:
        wget https://cnb.cool/ZhienXuan/Linux-Clipboard/-/releases/${VERSION}/downloads/linux-clipboard_${VERSION}_amd64.deb
        sudo dpkg -i linux-clipboard_${VERSION}_amd64.deb

      ä»“åº“é“¾æŽ¥:
        CNB: https://cnb.cool/ZhienXuan/Linux-Clipboard
        GitHub: https://github.com/Li-zhienxuan/Linux-Clipboard
      EOF

    - cat RELEASE_INFO_${VERSION}.txt
    - echo "âœ… Release ä¿¡æ¯å·²ç”Ÿæˆ"
  artifacts:
    paths:
      - RELEASE_INFO_*.txt
    expire_in: 30 days
  only:
    - /^v.*$/
  when: on_success

# æ‰‹åŠ¨è§¦å‘ - æž„å»ºæµ‹è¯•
build:manual:
  stage: build
  image: node:22
  script:
    - echo "ðŸ”§ æ‰‹åŠ¨è§¦å‘æž„å»ºæµ‹è¯•"
    - npm ci
    - npm run build
    - echo "âœ… æž„å»ºæµ‹è¯•å®Œæˆ"
  only:
    - main
  when: manual

# é€šçŸ¥ - æž„å»ºçŠ¶æ€
notify:success:
  stage: .post
  script:
    - echo "âœ… CI/CD æµç¨‹æ‰§è¡ŒæˆåŠŸ"
    - echo "é¡¹ç›®: ${PROJECT_NAME}"
    - echo "åˆ†æ”¯: ${CI_COMMIT_REF_NAME}"
    - echo "Commit: ${CI_COMMIT_SHORT_SHA}"
    - echo "Pipeline: ${CI_PIPELINE_URL}"
  when: on_success

notify:failure:
  stage: .post
  script:
    - echo "âŒ CI/CD æµç¨‹æ‰§è¡Œå¤±è´¥"
    - echo "é¡¹ç›®: ${PROJECT_NAME}"
    - echo "åˆ†æ”¯: ${CI_COMMIT_REF_NAME}"
    - echo "Commit: ${CI_COMMIT_SHORT_SHA}"
    - echo "è¯·æ£€æŸ¥æ—¥å¿—: ${CI_PIPELINE_URL}"
  when: on_failure
